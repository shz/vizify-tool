var fs = require('fs')
  , path = require('path')
  , async = require('async')
  , mkdirp = require('mkdirp')
  , card = require('../card')
  , compile = require('../compile')
  ;

module.exports = function(options) {
  var dir = process.cwd();
  var info = null;

  async.waterfall([
    // Load card info
    function(callback) {
      card.read(dir, callback);
    },

    // Compile card
    function(c, callback) {
      info = c;
      compile.compileCard({
        dir: dir,
        name: c.name
      }, 'javascript', callback);
    },

    // Write main.js to lib/index.js
    function(files, callback) {
      var d = path.join(dir, 'lib');
      mkdirp(d, function(err) {
        fs.writeFile(path.join(d, 'index.js'), files['main.js'], callback);
      });
    },

    // Write .npmignore
    function(callback) {
      fs.writeFile(path.join(dir, '.npmignore'), 'card.json\nsrc/\n', callback);
    },

    // Write package.json
    function(callback) {
      fs.writeFile(path.join(dir, 'package.json'), JSON.stringify({
        name: info.name,
        version: info.version,
        description: 'Autogenerated browserify module',
        main: 'lib/index.js'
        // More?  Probably
      }, null, 2), callback);
    },

    // Run npm publish and clean up files we created in above steps
    function(callback) {
      console.log('TODO - npm publish and cleanup');
      callback();
    }
  ], function(err) {
    if (err) {
      console.error(err.message);
      process.exit(1);
    }
  });
};
module.exports.doc = 'Publish to ynpm';
